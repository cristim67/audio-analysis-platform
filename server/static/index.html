<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è Audio Analysis Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 0;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
            color: #00ff00;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .status {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            border-radius: 0;
            padding: 10px 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 8px #00ff00;
        }

        .status-indicator.disconnected {
            background: #ff0000;
        }

        .waveform-section {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 20px;
        }

        .waveform-title {
            font-size: 14px;
            margin-bottom: 15px;
            color: #00ff00;
        }

        .waveform-container {
            background: #000000;
            border: 1px solid #00ff00;
            padding: 20px;
            height: 150px;
            position: relative;
            overflow: hidden;
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            border-radius: 0;
            padding: 15px;
        }

        .card-title {
            font-size: 11px;
            color: #00ff00;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .card-unit {
            font-size: 14px;
            color: #00aa00;
            margin-left: 5px;
        }

        .volume {
            color: #00ff00;
        }

        .peak {
            color: #ffff00;
        }

        .data-table {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            border-radius: 0;
            padding: 15px;
            overflow-x: auto;
        }

        .data-table h2 {
            font-size: 14px;
            margin-bottom: 15px;
            color: #00ff00;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #003300;
            font-size: 12px;
        }

        th {
            background: #001100;
            color: #00ff00;
            font-weight: bold;
        }

        tr:hover {
            background: #001100;
        }

        .timestamp {
            color: #00aa00;
            font-size: 11px;
        }

        .source-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #003300;
            border: 1px solid #00ff00;
            font-size: 10px;
            margin-left: 8px;
        }

        .source-arduino {
            color: #00ffff;
        }

        .source-laptop {
            color: #ff00ff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-title">üéôÔ∏è AUDIO ANALYSIS PLATFORM</div>
            <div class="recording-indicator">
                <span class="recording-dot" id="recordingDot"></span>
                <span id="recordingText">üî¥ Recording</span>
            </div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="statusText">Deconectat</span>
            </div>
            <div class="status-item">
                <strong>Ultima actualizare:</strong> <span id="lastUpdate">-</span>
            </div>
            <div class="status-item">
                <strong>SursƒÉ:</strong> <span id="sourceText">-</span>
            </div>
        </div>

        <div class="waveform-section">
            <div class="waveform-title">üìä WAVEFORM (Semnal √Æn timp)</div>
            <div class="waveform-container">
                <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <div class="card-title">üîä Volume</div>
                <div class="card-value">
                    <span class="volume" id="volume">-</span>
                    <span class="card-unit">%</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Peak to Peak</div>
                <div class="card-value">
                    <span class="peak" id="peakToPeak">-</span>
                    <span class="card-unit">ampl</span>
                </div>
            </div>
        </div>

        <div class="data-table">
            <h2>üìã Istoric recent</h2>
            <table>
                <thead>
                    <tr>
                        <th>Timp</th>
                        <th>Volume</th>
                        <th>Peak to Peak</th>
                        <th>SursƒÉ</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #00aa00;">
                            A»ôtept date audio...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let ws = null;
        let dataHistory = [];
        const maxHistoryRows = 20;
        let waveformData = [];
        const maxWaveformPoints = 50; // Show last 50 data points
        let canvas, ctx;
        let messageCount = 0; // Debug counter

        // Initialize canvas
        function initCanvas() {
            canvas = document.getElementById('waveformCanvas');
            ctx = canvas.getContext('2d');

            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                drawWaveform();
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function drawWaveform() {
            if (!ctx) return;

            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, width, height);

            // Draw horizontal grid lines
            ctx.strokeStyle = '#002200';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // Draw labels
            ctx.fillStyle = '#004400';
            ctx.font = '10px Courier New';
            ctx.fillText('100%', 5, 15);
            ctx.fillText('50%', 5, height / 2 + 4);
            ctx.fillText('0%', 5, height - 5);

            if (waveformData.length === 0) {
                ctx.fillStyle = '#003300';
                ctx.font = '14px Courier New';
                ctx.fillText('Waiting for data...', width / 2 - 70, height / 2);
                return;
            }

            // Draw filled area under waveform
            if (waveformData.length > 1) {
                const pointWidth = width / maxWaveformPoints;
                const startX = width - (waveformData.length * pointWidth);

                // Fill gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0.05)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.moveTo(startX, height);

                waveformData.forEach((value, index) => {
                    const x = startX + (index * pointWidth);
                    const y = height - (value / 100) * height;
                    ctx.lineTo(x, y);
                });

                ctx.lineTo(startX + ((waveformData.length - 1) * pointWidth), height);
                ctx.closePath();
                ctx.fill();

                // Draw line
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 5;
                ctx.beginPath();

                waveformData.forEach((value, index) => {
                    const x = startX + (index * pointWidth);
                    const y = height - (value / 100) * height;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();
                ctx.shadowBlur = 0;

                // Draw current value indicator
                const lastValue = waveformData[waveformData.length - 1];
                const lastX = startX + ((waveformData.length - 1) * pointWidth);
                const lastY = height - (lastValue / 100) * height;

                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws-dashboard`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ Conectat la WebSocket dashboard');
                console.log('üîó URL:', wsUrl);
                updateStatus(true);
                updateRecording(true);
                messageCount = 0;
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                messageCount++;

                // Debug: log messages with data
                if (message.source && message.volume !== undefined) {
                    console.log(`üì® #${messageCount} [${message.source}] vol=${message.volume} peak=${message.peakToPeak}`);
                }

                if (message.type === 'initial_data') {
                    console.log('üìã Initial data received:', message.data?.length || 0, 'items');
                    // Filter only Arduino data (has volume)
                    if (message.data) {
                        message.data
                            .filter(data => data.source === 'arduino' && data.volume !== undefined)
                            .forEach(data => processData(data));
                    }
                } else if (message.type === 'heartbeat') {
                    // Ignore heartbeats silently
                    return;
                } else {
                    // Process Arduino data (has volume and peakToPeak)
                    if (message.source === 'arduino' && message.volume !== undefined) {
                        processData(message);
                    }
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå Eroare WebSocket:', error);
                updateStatus(false);
                updateRecording(false);
            };

            ws.onclose = () => {
                console.log('‚ùå Deconectat de la WebSocket');
                updateStatus(false);
                updateRecording(false);
                // Reconectare imediatƒÉ fƒÉrƒÉ delay
                connectWebSocket();
            };
        }

        function processData(data) {
            // Only process Arduino data with volume
            if (data.source !== 'arduino' || data.volume === undefined) {
                return;
            }

            console.log('‚úÖ Processing Arduino data: volume=' + data.volume + ' peak=' + data.peakToPeak);

            // Update cards with animation
            const volumeEl = document.getElementById('volume');
            const peakEl = document.getElementById('peakToPeak');

            volumeEl.textContent = data.volume;
            peakEl.textContent = data.peakToPeak;

            // Flash effect on update
            volumeEl.style.textShadow = '0 0 20px #00ff00';
            peakEl.style.textShadow = '0 0 20px #ffff00';
            setTimeout(() => {
                volumeEl.style.textShadow = 'none';
                peakEl.style.textShadow = 'none';
            }, 100);

            // Update waveform using volume (0-100 scale)
            waveformData.push(data.volume);
            if (waveformData.length > maxWaveformPoints) {
                waveformData.shift();
            }
            drawWaveform();

            // Update timestamp
            const timestamp = new Date(data.timestamp || Date.now());
            document.getElementById('lastUpdate').textContent =
                timestamp.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Update source
            const sourceText = document.getElementById('sourceText');
            sourceText.textContent = 'Arduino üü¢';
            sourceText.className = 'source-arduino';

            // Add to history
            dataHistory.unshift(data);
            if (dataHistory.length > maxHistoryRows) {
                dataHistory.pop();
            }

            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('dataTableBody');

            // Filter only Arduino data with volume
            const arduinoData = dataHistory.filter(data =>
                data.source === 'arduino' && data.volume !== undefined
            );

            if (arduinoData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #00aa00;">
                            ‚è≥ A»ôtept date de la Arduino... (verificƒÉ consola browser F12)
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = arduinoData.slice(0, 10).map(data => {
                const timestamp = new Date(data.timestamp || Date.now());

                return `
                    <tr>
                        <td class="timestamp">${timestamp.toLocaleTimeString('ro-RO')}</td>
                        <td style="color: #00ff00; font-weight: bold;">${data.volume}%</td>
                        <td style="color: #ffff00;">${data.peakToPeak}</td>
                        <td><span class="source-badge source-arduino">Arduino</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Conectat';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Deconectat';
            }
        }

        function updateRecording(recording) {
            const dot = document.getElementById('recordingDot');
            const text = document.getElementById('recordingText');

            if (recording) {
                dot.style.display = 'inline-block';
                text.textContent = 'üî¥ Recording';
            } else {
                dot.style.display = 'none';
                text.textContent = '‚ö´ Stopped';
            }
        }

        // Initialize canvas and connect when page loads
        window.addEventListener('load', () => {
            initCanvas();
            connectWebSocket();
        });
    </script>
</body>

</html>